# 自动修复失败的测试
# 当测试失败时，使用 Claude 自动修复代码

name: Claude Code - 自动修复测试

on:
  # 当 PR 中有测试失败时触发
  pull_request:
    types: [opened, synchronize]
  # 手动触发
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue 编号'
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  # 首先运行测试
  run-tests:
    name: 运行测试
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 安装依赖
        run: npm ci

      - name: 运行测试
        id: test
        run: npm test
        continue-on-error: true

      # 如果测试失败，使用 Claude 修复
      - name: 让 Claude 修复失败的测试
        if: steps.test.outcome == 'failure'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            测试失败了。请分析失败的原因并修复代码。
            运行 npm test 查看具体的失败信息，然后修复 src/calculator.js 中的问题。
            确保所有测试通过后，创建一个 commit 并推送。
          claude_args: |
            --max-turns 10
            --model claude-sonnet-4-5

  # 手动触发：在 Issue 中使用 @claude fix
  manual-fix:
    name: 手动触发修复
    runs-on: ubuntu-latest
    # 只在手动触发时运行
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 安装依赖
        run: npm ci

      - name: 使用 Claude 修复
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            查看 Issue #${{ github.event.inputs.issue_number || 'latest' }}，
            理解问题并实现解决方案。
          claude_args: "--max-turns 10"
